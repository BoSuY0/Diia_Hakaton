# Інтеграція з Дією: JWT та айдентика

Цей документ описує, як сервіс працює з JWT від Дії, які клейми очікує, і як ці дані мапляться у внутрішню модель `user_id`.

## 1. Контракт JWT

- Алгоритм: `AUTH_JWT_ALGO` (за замовчуванням HS256; можна перейти на RS256, якщо отримаємо публічний ключ Дії).
- Перевірки:
  - `iss`: якщо задано `AUTH_JWT_ISSUER`, токен повинен його містити.
  - `aud`: якщо задано `AUTH_JWT_AUDIENCE`, токен повинен його містити.
  - `exp`: обов'язковий.
- Клейми, що нас цікавлять:
  - `sub` / `uid` / `user_id` — канонічний ідентифікатор користувача.
  - Додаткові (для префілу, якщо доступні): `name`/`full_name`, `drfo`/`rnokpp`/`tax_id`/`edrpou`, `address`, `phone`, `email`.

## 2. Внутрішній `user_id`

- Визначається як `AUTH_USER_PREFIX` + `<raw_sub>`. За замовчуванням префікс `diia:`.
- Всі ACL (`creator_user_id`, `role_owners`, історія, підпис, contracts DB) працюють з цим ідентифікатором.

## 3. Фронтенд

- Очікує, що Дія передасть JWT у `localStorage("diia_auth_token")` або через query/bootstrар скрипт.
- Усі запити додають `Authorization: Bearer <token>`. У проді `X-User-ID` ігнорується бекендом (`AUTH_MODE=jwt`).
- SSE підключення: `/sessions/{id}/stream?token=<jwt>`. На бекенді у jwt-режимі user_id береться лише з токена.

## 4. Профіль

- Ендпоінт `/me/profile` повертає `user_id` та розібрані клейми профілю (якщо токен наданий).

## 5. Що треба узгодити з Дією

1) Формат токена (issuer, audience, які клейми є стабільними).  
2) Ключ/секрет для верифікації (HS/RS).  
3) Як токен потрапляє у фронт (localStorage / BFF-проксі, що підшиває Authorization).  
4) SLA/TTL токена: чи треба refresh або короткий життєвий цикл.  

## 6. Після узгодження

- Встановити `AUTH_MODE=jwt`, `AUTH_JWT_SECRET`/`AUTH_JWT_ISSUER`/`AUTH_JWT_AUDIENCE` у `.env.prod`.  
- Прибрати використання `X-User-ID` у прод-деплою (у dev `AUTH_MODE=auto|header` залишаються для локальної роботи).  
